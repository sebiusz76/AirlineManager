@inject AirlineManager.Services.IConfigurationService ConfigService
@inject AirlineManager.Services.Interfaces.IThemeService ThemeService
@using Microsoft.AspNetCore.Identity
@using AirlineManager.Models.Domain
@inject UserManager<ApplicationUser> UserManager
@{
	string? userId = null;
	var currentUser = await UserManager.GetUserAsync(User);
	if (currentUser != null)
	{
		userId = currentUser.Id;
	}
	var effectiveTheme = await ThemeService.GetEffectiveThemeAsync(userId);
	var roles = currentUser != null ? await UserManager.GetRolesAsync(currentUser) : new List<string>();
}
<!DOCTYPE html>
<html lang="en" data-bs-theme="@effectiveTheme">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>@ViewData["Title"] - Admin Panel</title>
	<link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
	<link rel="stylesheet" href="~/lib/bootstrap-icons/font/bootstrap-icons.min.css" />
	<link rel="stylesheet" href="~/css/variables.css" asp-append-version="true" />
	<link rel="stylesheet" href="~/css/transitions.css" asp-append-version="true" />
	<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
	<link rel="stylesheet" href="~/css/dark-theme.css" asp-append-version="true" />
	<link rel="stylesheet" href="~/css/light-theme.css" asp-append-version="true" />
	<link rel="stylesheet" href="~/lib/sweetalert2/dist/sweetalert2.min.css" />
	<link rel="stylesheet" href="~/css/areas/Admin/_Layout.css" asp-append-version="true" />
	@await RenderSectionAsync("Styles", required: false)
</head>
<body>
	@{
		var maintenanceEnabled = await ConfigService.GetValueAsync<bool>("Maintenance_Mode_Enabled") ?? false;
		if (maintenanceEnabled && User.IsInRole("SuperAdmin"))
		{
			<div class="alert alert-warning mb-0 text-center maintenance-alert">
				<strong><i class="bi bi-exclamation-triangle-fill"></i> MAINTENANCE MODE ACTIVE</strong> -
				Only SuperAdmin users can access the site.
				<a asp-area="Admin" asp-controller="Maintenance" asp-action="Index" class="alert-link"><u>Manage Maintenance Mode</u></a>
			</div>
		}
	}

	<header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
		<a class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-6" asp-area="" asp-controller="Home" asp-action="Index">
			<i class="bi bi-airplane-engines me-2"></i>
			<span class="brand-text">Airline Manager</span>
		</a>
		<button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="navbar-nav">
			<div class="nav-item text-nowrap">
				<div class="d-flex align-items-center px-3">
					@{
						var displayName = currentUser != null ? $"{currentUser.FirstName} {currentUser.LastName}" : User.Identity?.Name;
						var initials = currentUser != null ? $"{currentUser.FirstName[0]}{currentUser.LastName[0]}" : "U";
					}
					<div class="dropdown">
						<a class="nav-link text-white dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
							<div class="user-avatar me-2">
								@initials
							</div>
							<span class="d-none d-md-inline">@displayName</span>
						</a>
						<ul class="dropdown-menu dropdown-menu-end dropdown-menu-custom shadow-lg border-0">
							<li class="dropdown-header">
								<div class="text-center py-2">
									<div class="user-avatar-large mx-auto mb-2">
										@initials
									</div>
									<div class="fw-bold">@displayName</div>
									<small class="text-muted">@currentUser?.Email</small>
								</div>
							</li>
							<li><hr class="dropdown-divider"></li>
							<li>
								<a class="dropdown-item" asp-area="" asp-controller="Account" asp-action="Profile">
									<i class="bi bi-person me-2 text-primary"></i>My Profile
								</a>
							</li>
							<li>
								<a class="dropdown-item" asp-area="" asp-controller="Account" asp-action="ActiveSessions">
									<i class="bi bi-display me-2 text-success"></i>Active Sessions
								</a>
							</li>
							<li>
								<a class="dropdown-item" asp-area="" asp-controller="Account" asp-action="LoginHistory">
									<i class="bi bi-clock-history me-2 text-info"></i>Login History
								</a>
							</li>
							<li><hr class="dropdown-divider"></li>
							<li>
								<form asp-area="" asp-controller="Account" asp-action="Logout" method="post" id="logoutForm" class="form-inline">
									<button type="submit" class="dropdown-item text-danger">
										<i class="bi bi-box-arrow-right me-2"></i>Sign Out
									</button>
								</form>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</header>

	<div class="container-fluid">
		<div class="row">
			<nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-body-tertiary sidebar collapse">
				<div class="position-sticky pt-3 sidebar-sticky">
					<ul class="nav flex-column">
						<li class="nav-item">
							<a class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "Dashboard" ? "active" : "")" asp-area="Admin" asp-controller="Dashboard" asp-action="Index">
								<i class="bi bi-speedometer2 me-2"></i>
								Dashboard
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "Users" ? "active" : "")" asp-area="Admin" asp-controller="Users" asp-action="Index">
								<i class="bi bi-people me-2"></i>
								Users
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "AppLogs" ? "active" : "")" asp-area="Admin" asp-controller="AppLogs" asp-action="Index">
								<i class="bi bi-card-text me-2"></i>
								Application Logs
							</a>
						</li>
					</ul>

					@if (User.IsInRole("SuperAdmin"))
					{
						<h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-body-secondary text-uppercase">
							<span>
								<i class="bi bi-shield-fill-check me-1"></i>
								SuperAdmin
							</span>
						</h6>
						<ul class="nav flex-column mb-2">
							<li class="nav-item">
								<a class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "Configuration" ? "active" : "")" asp-area="Admin" asp-controller="Configuration" asp-action="Index">
									<i class="bi bi-gear me-2"></i>
									Configuration
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "DataRetention" ? "active" : "")" asp-area="Admin" asp-controller="DataRetention" asp-action="Index">
									<i class="bi bi-trash me-2"></i>
									Data Retention
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link @(ViewContext.RouteData.Values["controller"]?.ToString() == "Maintenance" ? "active" : "")" asp-area="Admin" asp-controller="Maintenance" asp-action="Index">
									<i class="bi bi-tools me-2"></i>
									Maintenance Mode
								</a>
							</li>
						</ul>
					}

					<h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-body-secondary text-uppercase">
						<span>Navigation</span>
					</h6>
					<ul class="nav flex-column mb-2">
						<li class="nav-item">
							<a class="nav-link" asp-area="User" asp-controller="UserTest" asp-action="Index">
								<i class="bi bi-house-door me-2"></i>
								User Dashboard
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" asp-area="" asp-controller="Home" asp-action="Index">
								<i class="bi bi-arrow-left me-2"></i>
								Back to Main Site
							</a>
						</li>
					</ul>
				</div>
			</nav>

			<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
				<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
					<h1 class="h2">@ViewData["Title"]</h1>
					<div class="btn-toolbar mb-2 mb-md-0">
						@await RenderSectionAsync("PageActions", required: false)
					</div>
				</div>

				@RenderBody()
			</main>
		</div>
	</div>

	<!-- Cookie Consent Banner -->
	<div id="cookieConsent" role="alert" aria-live="assertive" aria-atomic="true">
		<div class="cookie-consent-container">
			<div class="cookie-consent-message">
				<h5>
					<i class="bi bi-shield-check"></i> We value your privacy
				</h5>
				<p>
					We use cookies to enhance your browsing experience, serve personalized content, and analyze our traffic.
					By clicking "Accept All", you consent to our use of cookies.
					<a asp-area="" asp-controller="Privacy" asp-action="Index">Learn more</a>
				</p>
			</div>
			<div class="cookie-consent-actions">
				<button type="button" id="acceptCookies" class="btn btn-cookie-accept">
					<i class="bi bi-check-circle"></i> Accept All
				</button>
				<button type="button" id="declineCookies" class="btn btn-cookie-decline">
					<i class="bi bi-x-circle"></i> Necessary Only
				</button>
			</div>
		</div>
	</div>

	<script src="~/lib/jquery/dist/jquery.min.js"></script>
	<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
	<script src="~/js/site.js" asp-append-version="true"></script>
	<script src="~/lib/sweetalert2/dist/sweetalert2.all.min.js"></script>
	<script src="~/js/views/Shared/_Layout.js" asp-append-version="true"></script>

	<!-- Toast data attributes for server-side notifications -->
	@if (TempData["ToastType"] != null && TempData["ToastMessage"] != null)
	{
		<div data-toast-type="@TempData["ToastType"]" data-toast-message="@TempData["ToastMessage"]" style="display:none;"></div>
	}

	@await RenderSectionAsync("Scripts", required: false)
</body>
</html>
