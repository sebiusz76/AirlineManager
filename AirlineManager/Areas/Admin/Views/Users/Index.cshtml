@model IEnumerable<AirlineManager.Models.ViewModel.AdminUserViewModel>

@{
	ViewData["Title"] = "Users";
	var currentPage = ViewBag.CurrentPage as int? ?? 1;
	var pageSize = ViewBag.PageSize as int? ?? 10;
	var totalPages = ViewBag.TotalPages as int? ?? 1;
	var totalCount = ViewBag.TotalCount as int? ?? 0;
	var search = ViewBag.Search as string ?? string.Empty;
	var roleFilter = ViewBag.RoleFilter as string ?? string.Empty;
	var availableRoles = ViewBag.AvailableRoles as List<string> ?? new List<string>();
	var isSuperAdmin = User.IsInRole("SuperAdmin");
}

<h1><i class="bi bi-people"></i> Users</h1>

<form method="get" class="row g-3 mb-3">
	<div class="col-auto">
		<input type="text" name="search" value="@search" class="form-control"
			placeholder="Search name or email" />
	</div>
	<div class="col-auto">
		<select name="roleFilter" class="form-select">
			<option value="">All roles</option>
			@foreach (var r in availableRoles) {
				@if (r == roleFilter) {
					<option value="@r" selected="selected">@r</option>
				} else {
					<option value="@r">@r</option>
				}
			}
		</select>
	</div>
	<div class="col-auto">
		<button class="btn btn-primary" type="submit">Filter</button>
	</div>
</form>

<table class="table">
	<thead>
		<tr>
			<th>Email</th>
			<th>Name</th>
			<th>Role</th>
			<th>Activated</th>
			<th>Locked</th>
			@if (isSuperAdmin)
			{
				<th>2FA</th>
			}
			<th></th>
		</tr>
	</thead>
	<tbody>
		@foreach (var user in Model) {
			<tr>
				<td>@user.Email</td>
				<td>@user.FirstName @user.LastName</td>
				<td>@user.Role</td>
				<td>
					@if (user.EmailConfirmed)
					{
						<span class="badge rounded-pill bg-success">Yes</span>
					}
					else
					{
						<span class="badge rounded-pill bg-warning">No</span>
					}
				</td>
				<td>
					@if (user.IsLockedOut)
					{
						<span class="badge rounded-pill bg-danger">Yes</span>
					}
					else
					{
						<span class="badge rounded-pill bg-success">No</span>
					}
				</td>
				@if (isSuperAdmin)
				{
					<td>
						@if (user.TwoFactorEnabled)
						{
							<span class="badge rounded-pill bg-success">Enabled</span>
						}
						else
						{
							<span class="badge rounded-pill bg-secondary">Disabled</span>
						}
					</td>
				}
				<td>
					<div class="dropdown">
						<button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
								id="dropdownActions@(user.Id)" data-bs-toggle="dropdown" aria-expanded="false">
							Actions
						</button>
						<ul class="dropdown-menu" aria-labelledby="dropdownActions@(user.Id)">
							<li>
								<a class="dropdown-item" asp-area="Admin" asp-controller="Users" asp-action="Edit"
								   asp-route-id="@user.Id">
									<i class="bi bi-pencil-square"></i> Edit
								</a>
							</li>
							<li>
								<a class="dropdown-item" asp-area="Admin" asp-controller="Users" asp-action="AuditLog"
								   asp-route-id="@user.Id">
									<i class="bi bi-clock-history"></i> Audit Log
								</a>
							</li>
							<li>
								<a class="dropdown-item" asp-area="Admin" asp-controller="Users" asp-action="LoginHistory"
								   asp-route-id="@user.Id">
									<i class="bi bi-shield-lock"></i> Login History
								</a>
							</li>
							<li>
								<a class="dropdown-item" asp-area="Admin" asp-controller="Users" asp-action="SetPassword"
								   asp-route-id="@user.Id">
									<i class="bi bi-key"></i> Set Password
								</a>
							</li>
							@if (!user.EmailConfirmed)
							{
								<li><hr class="dropdown-divider"></li>
								<li>
									<form asp-area="Admin" asp-controller="Users" asp-action="ActivateAccount"
										asp-route-id="@user.Id" method="post" class="d-inline-block w-100">
										@Html.AntiForgeryToken()
										<button type="submit" class="dropdown-item text-success js-activate-account"
											data-email="@user.Email">
											<i class="bi bi-check-circle"></i> Activate Account
										</button>
									</form>
								</li>
							}
							@if (user.IsLockedOut)
							{
								<li><hr class="dropdown-divider"></li>
								<li>
									<form asp-area="Admin" asp-controller="Users" asp-action="UnlockAccount"
										asp-route-id="@user.Id" method="post" class="d-inline-block w-100">
										@Html.AntiForgeryToken()
										<button type="submit" class="dropdown-item text-warning js-unlock-account"
											data-email="@user.Email">
											<i class="bi bi-unlock"></i> Unlock Account
										</button>
									</form>
								</li>
							}
							@if (isSuperAdmin && user.TwoFactorEnabled)
							{
								<li><hr class="dropdown-divider"></li>
								<li>
									<form asp-area="Admin" asp-controller="Users" asp-action="DisableTwoFactor"
										asp-route-id="@user.Id" method="post" class="d-inline-block w-100">
										@Html.AntiForgeryToken()
										<button type="submit" class="dropdown-item text-info js-disable-2fa"
											data-email="@user.Email">
											<i class="bi bi-shield-x"></i> Disable 2FA
										</button>
									</form>
								</li>
							}
							<li><hr class="dropdown-divider"></li>
							<li>
								<form asp-area="Admin" asp-controller="Users" asp-action="Delete"
									asp-route-id="@user.Id" method="post" class="d-inline-block w-100">
									@Html.AntiForgeryToken()
									<button type="submit" class="dropdown-item text-danger js-delete-user"
										data-email="@user.Email">
										<i class="bi bi-trash"></i> Delete
									</button>
								</form>
							</li>
						</ul>
					</div>
				</td>
			</tr>
		}
	</tbody>
</table>

<nav>
	<ul class="pagination">
		<li class="page-item @(currentPage == 1 ? "disabled" : "")">
			<a class="page-link" href="?search=@search&roleFilter=@roleFilter&page=@(currentPage - 1)&pageSize=@pageSize">Previous</a>
		</li>
		@for (int p = 1; p <= totalPages; p++) {
			<li class="page-item @(p == currentPage ? "active" : "")"><a class="page-link"
				href="?search=@search&roleFilter=@roleFilter&page=@p&pageSize=@pageSize">@p</a></li>
		}
		<li class="page-item @(currentPage == totalPages ? "disabled" : "")">
			<a class="page-link" href="?search=@search&roleFilter=@roleFilter&page=@(currentPage + 1)&pageSize=@pageSize">Next</a>
		</li>
	</ul>
</nav>

@section Scripts {
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script>
		document.querySelectorAll('.js-activate-account').forEach(function(btn) {
			btn.addEventListener('click', function(e) {
				e.preventDefault();
				var email = this.dataset.email;
				var form = this.closest('form');
				
				Swal.fire({
					title: 'Activate Account?',
					html: 'This will activate the account for user <strong>' + email + '</strong>.<br>The user will be able to log in without email confirmation.',
					icon: 'question',
					showCancelButton: true,
					confirmButtonColor: '#28a745',
					cancelButtonColor: '#6c757d',
					confirmButtonText: 'Yes, activate it',
					cancelButtonText: 'Cancel'
				}).then(function(result) {
					if (result.isConfirmed) {
						form.submit();
					}
				});
			});
		});

		document.querySelectorAll('.js-unlock-account').forEach(function(btn) {
			btn.addEventListener('click', function(e) {
				e.preventDefault();
				var email = this.dataset.email;
				var form = this.closest('form');
				
				Swal.fire({
					title: 'Unlock Account?',
					html: 'This will unlock the account for user <strong>' + email + '</strong>.<br>Failed login attempts will be reset.',
					icon: 'question',
					showCancelButton: true,
					confirmButtonColor: '#ffc107',
					cancelButtonColor: '#6c757d',
					confirmButtonText: 'Yes, unlock it',
					cancelButtonText: 'Cancel'
				}).then(function(result) {
					if (result.isConfirmed) {
						form.submit();
					}
				});
			});
		});

		document.querySelectorAll('.js-disable-2fa').forEach(function(btn) {
			btn.addEventListener('click', function(e) {
				e.preventDefault();
				var email = this.dataset.email;
				var form = this.closest('form');
				
				Swal.fire({
					title: 'Disable Two-Factor Authentication?',
					html: 'This will disable 2FA for user <strong>' + email + '</strong>.<br>The user will need to reconfigure it if they want to enable it again.',
					icon: 'warning',
					showCancelButton: true,
					confirmButtonColor: '#17a2b8',
					cancelButtonColor: '#6c757d',
					confirmButtonText: 'Yes, disable it',
					cancelButtonText: 'Cancel'
				}).then(function(result) {
					if (result.isConfirmed) {
						form.submit();
					}
				});
			});
		});

		document.querySelectorAll('.js-delete-user').forEach(function(btn) {
			btn.addEventListener('click', function(e) {
				e.preventDefault();
				var email = this.dataset.email;
				var form = this.closest('form');
				
				Swal.fire({
					title: 'Delete User?',
					html: 'Are you sure you want to delete user <strong>' + email + '</strong>?<br>This action cannot be undone.',
					icon: 'error',
					showCancelButton: true,
					confirmButtonColor: '#d33',
					cancelButtonColor: '#6c757d',
					confirmButtonText: 'Yes, delete it',
					cancelButtonText: 'Cancel'
				}).then(function(result) {
					if (result.isConfirmed) {
						form.submit();
					}
				});
			});
		});
	</script>
}