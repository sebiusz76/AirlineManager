@model AirlineManager.Models.ViewModel.ProfileCompositeViewModel
@inject Microsoft.AspNetCore.Identity.UserManager<AirlineManager.Models.Domain.ApplicationUser> UserManager

@{
	ViewData["Title"] = "Profile";
	var daysUntilExpiration = ViewBag.DaysUntilPasswordExpiration as int?;
	var isPasswordExpired = ViewBag.IsPasswordExpired as bool? ?? false;
}

@section Styles {
	<link rel="stylesheet" href="~/css/views/Account/Profile.css" asp-append-version="true" />
}

<div class="container py-4">
	<!-- Profile Header with Avatar -->
	<div class="row">
		<div class="col-12">
			<!-- Profile Header Card -->
			<div class="card shadow-lg border-0 mb-4 profile-header-gradient">
				<div class="card-body p-4">
					<div class="row align-items-center">
						<div class="col-md-2 text-center mb-3 mb-md-0">
							<!-- Avatar Section -->
							<div class="position-relative d-inline-block">
								@{
									var user = await UserManager.GetUserAsync(User);
									var initials = user != null ? $"{user.FirstName[0]}{user.LastName[0]}" : "U";
									var avatarUrl = user?.AvatarUrl;
								}
								<div class="avatar-large" id="profileAvatar">
									@if (!string.IsNullOrEmpty(avatarUrl))
									{
										<img src="@avatarUrl" alt="Avatar" class="avatar-img" />
									}
									else
									{
										<div class="avatar-initials">@initials</div>
									}
								</div>
								<button type="button" class="btn btn-light btn-sm avatar-edit-btn" data-bs-toggle="modal" data-bs-target="#avatarModal">
									<i class="bi bi-camera-fill"></i>
								</button>
							</div>
						</div>
						<div class="col-md-7">
							<h2 class="text-white mb-2">@user?.FirstName @user?.LastName</h2>
							<p class="text-white-50 mb-1">
								<i class="bi bi-envelope me-2"></i>@user?.Email
							</p>
							<p class="text-white-50 mb-0">
								<i class="bi bi-shield-check me-2"></i>
								@{
									var roles = await UserManager.GetRolesAsync(user);
								}
								@string.Join(", ", roles)
							</p>
						</div>
						<div class="col-md-3 text-md-end">
							<div class="text-white-50 small">
								<i class="bi bi-calendar3 me-2"></i>Member since
							</div>
							@{
								// Use PasswordChangedAt as member since date
								DateTime memberSince = user?.PasswordChangedAt ?? DateTime.UtcNow;
							}
							<div class="text-white fw-bold">@memberSince.ToString("MMM dd, yyyy")</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	@if (isPasswordExpired)
	{
		<div class="alert alert-danger alert-dismissible fade show">
			<i class="bi bi-shield-exclamation"></i> <strong>Your password has expired!</strong>
			Please <a asp-action="ChangePassword" class="alert-link">change your password</a> as soon as possible.
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		</div>
	}
	else if (daysUntilExpiration.HasValue && daysUntilExpiration.Value <= 14 && daysUntilExpiration.Value > 0)
	{
		<div class="alert alert-warning alert-dismissible fade show">
			<i class="bi bi-exclamation-triangle"></i> <strong>Password expiring soon!</strong>
			Your password will expire in <strong>@daysUntilExpiration.Value day(s)</strong>.
			<a asp-action="ChangePassword" class="alert-link">Change it now</a> to avoid interruption.
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		</div>
	}

	<!-- Hidden antiforgery token for AJAX requests -->
	<form id="antiforgeryForm" class="antiforgery-form-hidden">@Html.AntiForgeryToken()</form>

	<!-- Avatar Upload Modal -->
	<div class="modal fade" id="avatarModal" tabindex="-1" aria-labelledby="avatarModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header bg-primary text-white">
					<h5 class="modal-title" id="avatarModalLabel">
						<i class="bi bi-camera"></i> Change Avatar
					</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p class="text-muted">Choose an option to update your profile picture:</p>
					<div class="d-grid gap-2">
						<button type="button" class="btn btn-outline-primary" onclick="alert('Upload image functionality - to be implemented')">
							<i class="bi bi-upload me-2"></i>Upload Image
						</button>
						<button type="button" class="btn btn-outline-secondary" onclick="alert('Choose from gallery - to be implemented')">
							<i class="bi bi-images me-2"></i>Choose from Gallery
						</button>
						@if (!string.IsNullOrEmpty(avatarUrl))
						{
							<button type="button" class="btn btn-outline-danger" onclick="removeAvatar()">
								<i class="bi bi-trash me-2"></i>Remove Avatar
							</button>
						}
					</div>
					<div class="mt-3">
						<small class="text-muted">
							<i class="bi bi-info-circle"></i>
							Supported formats: JPG, PNG, GIF (max 2MB)
						</small>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Recovery Codes Modal -->
	<div class="modal fade" id="recoveryCodesModal" tabindex="-1" aria-labelledby="recoveryCodesModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="recoveryCodesModalLabel">Recovery Codes</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="alert alert-warning">
						<strong>Important!</strong> Save these recovery codes in a safe place. You can use them to sign in if you lose access to your authenticator app.
					</div>
					<pre id="modalRecoveryCodes" class="p-3 bg-light border rounded recovery-codes-display"></pre>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" id="btnCopyRecoveryCodes">
						<i class="bi bi-clipboard"></i> Copy to clipboard
					</button>
					<button type="button" class="btn btn-primary" id="btnDownloadRecoveryCodes">
						<i class="bi bi-download"></i> Download as file
					</button>
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<ul class="nav nav-tabs nav-tabs-custom" id="profileTabs" role="tablist">
		<li class="nav-item" role="presentation">
			<button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
				<i class="bi bi-person-circle me-2"></i>Info
			</button>
		</li>
		<li class="nav-item" role="presentation">
			<button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email" type="button" role="tab">
				<i class="bi bi-envelope me-2"></i>Email
			</button>
		</li>
		<li class="nav-item" role="presentation">
			<button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button" role="tab">
				<i class="bi bi-lock me-2"></i>Password
			</button>
		</li>
		<li class="nav-item" role="presentation">
			<button class="nav-link" id="appearance-tab" data-bs-toggle="tab" data-bs-target="#appearance" type="button" role="tab">
				<i class="bi bi-palette me-2"></i>Appearance
			</button>
		</li>
		<li class="nav-item" role="presentation">
			<button class="nav-link" id="twofactor-tab" data-bs-toggle="tab" data-bs-target="#twofactor" type="button" role="tab">
				<i class="bi bi-shield-lock me-2"></i>Two-Factor
			</button>
		</li>
		<li class="nav-item" role="presentation">
			<button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
				<i class="bi bi-shield-check me-2"></i>Security
			</button>
		</li>
		<li class="nav-item" role="presentation">
			<button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export" type="button" role="tab">
				<i class="bi bi-download me-2"></i>Export / Delete
			</button>
		</li>
	</ul>

	<div class="tab-content mt-4" id="profileTabsContent">
		<div class="tab-pane fade show active" id="info" role="tabpanel">
			<div class="card shadow-sm border-0">
				<div class="card-body p-4">
					<h5 class="card-title mb-4">
						<i class="bi bi-person-badge text-primary me-2"></i>Personal Information
					</h5>
					<form asp-action="ProfileInfo" method="post" class="edit-form">
						@Html.AntiForgeryToken()
						<div class="row">
							<div class="col-md-6 mb-3">
								<label asp-for="Info.FirstName" class="form-label fw-bold"></label>
								<div class="input-group">
									<span class="input-group-text"><i class="bi bi-person"></i></span>
									<input asp-for="Info.FirstName" class="form-control" />
								</div>
								<span asp-validation-for="Info.FirstName" class="text-danger small"></span>
							</div>
							<div class="col-md-6 mb-3">
								<label asp-for="Info.LastName" class="form-label fw-bold"></label>
								<div class="input-group">
									<span class="input-group-text"><i class="bi bi-person"></i></span>
									<input asp-for="Info.LastName" class="form-control" />
								</div>
								<span asp-validation-for="Info.LastName" class="text-danger small"></span>
							</div>
						</div>
						<button type="submit" class="btn btn-primary">
							<i class="bi bi-check-circle me-2"></i>Save Changes
						</button>
					</form>
				</div>
			</div>
		</div>

		<div class="tab-pane fade" id="email" role="tabpanel">
			<div class="card shadow-sm border-0">
				<div class="card-body p-4">
					<h5 class="card-title mb-4">
						<i class="bi bi-envelope-at text-primary me-2"></i>Email Address
					</h5>
					<form asp-action="ProfileEmail" method="post" class="edit-form">
						@Html.AntiForgeryToken()
						<div class="mb-3">
							<label asp-for="Email.Email" class="form-label fw-bold"></label>
							<div class="input-group">
								<span class="input-group-text"><i class="bi bi-envelope"></i></span>
								<input asp-for="Email.Email" class="form-control" />
							</div>
							<span asp-validation-for="Email.Email" class="text-danger small"></span>
						</div>
						<div class="mb-3">
							<label asp-for="Email.CurrentPassword" class="form-label fw-bold"></label>
							<div class="input-group">
								<span class="input-group-text"><i class="bi bi-key"></i></span>
								<input asp-for="Email.CurrentPassword" class="form-control" type="password" />
							</div>
							<span asp-validation-for="Email.CurrentPassword" class="text-danger small"></span>
							<small class="text-muted">Required to confirm your identity</small>
						</div>
						<button type="submit" class="btn btn-primary">
							<i class="bi bi-check-circle me-2"></i>Update Email
						</button>
					</form>
				</div>
			</div>
		</div>

		<div class="tab-pane fade" id="password" role="tabpanel">
			<div class="card shadow-sm border-0">
				<div class="card-body p-4">
					<h5 class="card-title mb-4">
						<i class="bi bi-shield-lock text-primary me-2"></i>Change Password
					</h5>
					<form asp-action="ProfilePassword" method="post" class="edit-form">
						@Html.AntiForgeryToken()
						<div class="mb-3">
							<label asp-for="Password.CurrentPassword" class="form-label fw-bold"></label>
							<div class="input-group">
								<span class="input-group-text"><i class="bi bi-key"></i></span>
								<input asp-for="Password.CurrentPassword" class="form-control" type="password" />
							</div>
							<span asp-validation-for="Password.CurrentPassword" class="text-danger small"></span>
						</div>
						<div class="mb-3">
							<label asp-for="Password.NewPassword" class="form-label fw-bold"></label>
							<div class="input-group">
								<span class="input-group-text"><i class="bi bi-lock"></i></span>
								<input asp-for="Password.NewPassword" class="form-control" type="password" />
							</div>
							<span asp-validation-for="Password.NewPassword" class="text-danger small"></span>
						</div>
						<div class="mb-3">
							<label asp-for="Password.ConfirmPassword" class="form-label fw-bold"></label>
							<div class="input-group">
								<span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
								<input asp-for="Password.ConfirmPassword" class="form-control" type="password" />
							</div>
							<span asp-validation-for="Password.ConfirmPassword" class="text-danger small"></span>
						</div>

						@if (ViewBag.PasswordRequirements != null && ((List<string>)ViewBag.PasswordRequirements).Any())
						{
							<div class="alert alert-info">
								<i class="bi bi-info-circle"></i>
								<strong>Password requirements:</strong>
								<ul class="mb-0 mt-2 small">
									@foreach (var requirement in (List<string>)ViewBag.PasswordRequirements)
									{
										<li>@requirement</li>
									}
								</ul>
							</div>
						}

						<button type="submit" class="btn btn-primary">
							<i class="bi bi-check-circle me-2"></i>Change Password
						</button>
					</form>
				</div>
			</div>
		</div>

		<div class="tab-pane fade" id="appearance" role="tabpanel">
			<div class="card shadow-sm border-0">
				<div class="card-body p-4">
					<h5 class="card-title mb-4">
						<i class="bi bi-palette text-primary me-2"></i>Theme & Appearance
					</h5>
					
					<div class="mb-4">
						<label for="profileThemeSelect" class="form-label fw-bold">Select Theme</label>
						<select class="form-control-modern" id="profileThemeSelect" aria-label="Select theme">
							<optgroup label="System">
								<option value="auto">🔄 Auto (System)</option>
							</optgroup>
							<optgroup label="Light Themes">
								<option value="light">☀️ Light (Soft)</option>
								<option value="light-crisp">🌞 Light (Crisp)</option>
								<option value="light-warm">🌅 Light (Warm)</option>
							</optgroup>
							<optgroup label="Dark Themes">
								<option value="dark">🌙 Dark (Soft)</option>
								<option value="dark-slate">🌟 Dark (Slate)</option>
								<option value="dark-midnight">🌚 Dark (Midnight)</option>
							</optgroup>
						</select>
						<small class="text-muted d-block mt-2" id="profileThemeDescription">
							<i class="bi bi-info-circle"></i> <span id="profileThemeDescriptionText">Choose your preferred theme</span>
						</small>
					</div>

					<div class="alert-modern alert-gradient-info">
						<i class="bi bi-info-circle-fill"></i>
						<div>
							<strong>Current Theme:</strong> <span id="currentThemeDisplay" class="badge-modern badge-gradient-primary">Auto</span>
							<br><small class="mt-1 d-block">Your theme preference is automatically saved and will be applied across all your devices.</small>
						</div>
					</div>

					<div class="mt-4">
						<a asp-area="" asp-controller="Theme" asp-action="Variants" class="btn-modern btn-gradient-primary" target="_blank">
							<i class="bi bi-palette me-2"></i>Compare All Themes
						</a>
					</div>
				</div>
			</div>
		</div>

		<div class="tab-pane fade" id="security" role="tabpanel">
			<div class="row g-4">
				<div class="col-md-6">
					<div class="card-modern hover-lift h-100">
						<div class="card-body-modern">
							<div class="d-flex align-items-center mb-3">
								<div class="feature-icon bg-success bg-gradient text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
									<i class="bi bi-display" style="font-size: 1.5rem;"></i>
								</div>
								<div>
									<h5 class="mb-0">Active Sessions</h5>
									<small class="text-muted">Manage your devices</small>
								</div>
							</div>
							<p class="text-muted mb-3">
View and manage all devices currently logged into your account. You can revoke access from any device at any time.
							</p>
							<a asp-action="ActiveSessions" class="btn-modern btn-gradient-success w-100">
								<i class="bi bi-display me-2"></i>View Active Sessions
							</a>
						</div>
					</div>
				</div>

				<div class="col-md-6">
					<div class="card-modern hover-lift h-100">
						<div class="card-body-modern">
							<div class="d-flex align-items-center mb-3">
								<div class="feature-icon bg-info bg-gradient text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
									<i class="bi bi-clock-history" style="font-size: 1.5rem;"></i>
								</div>
								<div>
									<h5 class="mb-0">Login History</h5>
									<small class="text-muted">Track your account activity</small>
								</div>
							</div>
							<p class="text-muted mb-3">
								Review recent login activity including timestamps, locations, and devices used to access your account.
							</p>
							<a asp-action="LoginHistory" class="btn-modern btn-gradient-info w-100">
								<i class="bi bi-clock-history me-2"></i>View Login History
							</a>
						</div>
					</div>
				</div>
			</div>

			<div class="card-modern mt-4">
				<div class="card-body-modern">
					<h5 class="mb-3">
						<i class="bi bi-shield-check text-primary me-2"></i>Security Recommendations
					</h5>
					<div class="row g-3">
						<div class="col-md-6">
							<div class="d-flex align-items-start">
								<i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
								<div>
									<strong>Use Strong Passwords</strong>
									<p class="small text-muted mb-0">Include uppercase, lowercase, numbers, and special characters</p>
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="d-flex align-items-start">
								<i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
								<div>
									<strong>Enable Two-Factor Authentication</strong>
									<p class="small text-muted mb-0">Add an extra layer of security to your account</p>
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="d-flex align-items-start">
								<i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
								<div>
									<strong>Review Active Sessions Regularly</strong>
									<p class="small text-muted mb-0">Check for any unauthorized access to your account</p>
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="d-flex align-items-start">
								<i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
								<div>
									<strong>Monitor Login History</strong>
									<p class="small text-muted mb-0">Stay informed about account access patterns</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="tab-pane fade" id="twofactor" role="tabpanel">
			<div class="card shadow-sm border-0">
				<div class="card-body p-4">
					<h5 class="card-title mb-4">
						<i class="bi bi-shield-lock text-primary me-2"></i>Two-Factor Authentication
					</h5>
					@{
						var twoFactor = Model.TwoFactor;
						var is2faEnabled = twoFactor?.Is2faEnabled ?? false;
						var recoveryCodesLeft = twoFactor?.RecoveryCodesLeft as int?;
					}
					@if (is2faEnabled)
					{
						<div class="alert alert-success rounded-3">
							<div class="d-flex align-items-center">
								<i class="bi bi-check-circle-fill me-3" style="font-size: 1.5rem;"></i>
								<div>
									<strong>Two-factor authentication is enabled</strong>
									<p class="mb-0 mt-1 small">Your account is protected with two-factor authentication using an authenticator app.</p>
								</div>
							</div>
						</div>

						@if (recoveryCodesLeft != null)
						{
							var codesLeft = recoveryCodesLeft.Value;
							if (codesLeft == 0)
							{
								<div class="alert alert-danger rounded-3">
									<div class="d-flex align-items-start">
										<i class="bi bi-exclamation-triangle-fill me-3 mt-1" style="font-size: 1.5rem;"></i>
										<div>
											<strong>Warning! No recovery codes remaining</strong>
											<p class="mb-0 mt-1 small">You have no recovery codes left. Generate new recovery codes immediately to avoid being locked out of your account.</p>
										</div>
									</div>
								</div>
							}
							else if (codesLeft <= 3)
							{
								<div class="alert alert-warning rounded-3">
									<div class="d-flex align-items-start">
										<i class="bi bi-exclamation-triangle me-3 mt-1" style="font-size: 1.5rem;"></i>
										<div>
											<strong>Warning! Low recovery codes</strong>
											<p class="mb-0 mt-1 small">You have only <strong>@codesLeft</strong> recovery code(s) left. Consider generating new recovery codes soon.</p>
										</div>
									</div>
								</div>
							}
							else
							{
								<div class="alert alert-info rounded-3">
									<div class="d-flex align-items-center">
										<i class="bi bi-info-circle-fill me-3" style="font-size: 1.5rem;"></i>
										<div>
											<strong>Recovery codes available</strong>
											<p class="mb-0 mt-1 small">You have <strong>@codesLeft</strong> recovery code(s) remaining. Keep them in a safe place.</p>
										</div>
									</div>
								</div>
							}
						}

						<div class="d-grid gap-2 d-md-flex mt-4">
							<button id="tfResetRecovery" class="btn btn-warning">
								<i class="bi bi-arrow-clockwise me-2"></i>Reset Recovery Codes
							</button>
							<button id="tfDisable" class="btn btn-danger">
								<i class="bi bi-x-circle me-2"></i>Disable 2FA
							</button>
						</div>
					}
					else
					{
						<div class="alert alert-warning rounded-3 mb-4">
							<div class="d-flex align-items-start">
								<i class="bi bi-shield-exclamation me-3 mt-1" style="font-size: 1.5rem;"></i>
								<div>
									<strong>Two-factor authentication is not enabled</strong>
									<p class="mb-0 mt-2 small">
										Add an extra layer of security to your account by enabling two-factor authentication. 
										You'll need an authenticator app like Google Authenticator, Microsoft Authenticator, or Authy.
									</p>
								</div>
							</div>
						</div>

						<div class="mb-4">
							<h6 class="fw-bold mb-3"><i class="bi bi-info-circle me-2"></i>How it works</h6>
							<ol class="small text-muted">
								<li class="mb-2">Click "Configure Authenticator" to generate a QR code</li>
								<li class="mb-2">Scan the QR code with your authenticator app</li>
								<li class="mb-2">Enter the 6-digit code from your app to verify</li>
								<li class="mb-2">Save your recovery codes in a secure location</li>
							</ol>
						</div>

						<button id="tfConfigure" class="btn btn-primary btn-lg">
							<i class="bi bi-shield-plus me-2"></i>Configure Authenticator
						</button>
					}
					
					<!-- 2FA Setup Area (hidden by default) -->
					<div id="tfArea" class="tfa-setup-area" style="display:none; margin-top:24px;">
						<hr class="my-4" />
						
						<div class="row">
							<div class="col-md-6 mb-4">
								<h6 class="fw-bold mb-3">
									<i class="bi bi-qr-code me-2"></i>Step 1: Scan QR Code
								</h6>
								<div id="tfQr" class="tfa-qr-container"></div>
								<p class="small text-muted mt-2 text-center">
									Scan this QR code with your authenticator app
								</p>
							</div>
							
							<div class="col-md-6 mb-4">
								<h6 class="fw-bold mb-3">
									<i class="bi bi-key-fill me-2"></i>Manual Entry Key
								</h6>
								<div id="tfKey" class="mb-3"></div>
								
								<h6 class="fw-bold mb-3 mt-4">
									<i class="bi bi-shield-check me-2"></i>Step 2: Verify Code
								</h6>
								<label for="tfCode" class="form-label">Enter the 6-digit code from your app</label>
								<input id="tfCode" 
									   type="text" 
									   class="form-control form-control-lg text-center" 
									   placeholder="000000"
									   autocomplete="one-time-code"
									   inputmode="numeric"
									   maxlength="6"
									   pattern="[0-9]{6}"
									   style="font-family: monospace; font-size: 1.5rem; letter-spacing: 0.5rem;" />
								<div id="tfFeedback" class="alert alert-danger mt-2" style="display:none;"></div>
								
								<div class="d-grid gap-2 mt-3">
									<button id="tfEnable" class="btn btn-success btn-lg">
										<i class="bi bi-check-circle me-2"></i>Enable 2FA
									</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="tab-pane fade" id="export" role="tabpanel">
			<div class="card shadow-sm border-0 mb-4">
				<div class="card-body p-4">
					<h5 class="card-title mb-4">
						<i class="bi bi-download text-primary me-2"></i>Download Your Data
					</h5>
					<p>You can download all data related to your account as a JSON file. This will include your profile, roles and related entities.</p>
					<form asp-action="ExportData" method="post">
						@Html.AntiForgeryToken()
						<button type="submit" class="btn btn-primary">
							<i class="bi bi-file-earmark-arrow-down me-2"></i>Download My Data
						</button>
					</form>
				</div>
			</div>

			<div class="card shadow-sm border-danger">
				<div class="card-body p-4">
					<h5 class="card-title mb-4 text-danger">
						<i class="bi bi-exclamation-triangle me-2"></i>Delete Account
					</h5>
					<p>Deleting your account will remove your user data. <strong>This action is irreversible.</strong></p>
					<form asp-action="DeleteAccount" method="post" class="delete-form">
						@Html.AntiForgeryToken()
						<div class="mb-3">
							<label asp-for="Delete.CurrentPassword" class="form-label fw-bold"></label>
							<div class="input-group">
								<span class="input-group-text"><i class="bi bi-key"></i></span>
								<input asp-for="Delete.CurrentPassword" class="form-control" type="password" />
							</div>
							<span asp-validation-for="Delete.CurrentPassword" class="text-danger small"></span>
							<small class="text-muted">Required to confirm your identity</small>
						</div>
						<button type="submit" class="btn btn-danger">
							<i class="bi bi-trash me-2"></i>Delete My Account
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<partial name="_ValidationScriptsPartial" />
	
	<!-- QRCode.js library for 2FA QR code generation -->
	<script src="~/lib/qrcodejs/qrcode.min.js"></script>
	
	<!-- Profile page scripts -->
	<script src="~/js/views/Account/Profile.js" asp-append-version="true"></script>
	
	<!-- Theme selection in Profile page -->
	<script>
		// Sync profile theme select with global theme manager
		document.addEventListener('DOMContentLoaded', function() {
			const profileThemeSelect = document.getElementById('profileThemeSelect');
			const currentThemeDisplay = document.getElementById('currentThemeDisplay');
			const profileThemeDescText = document.getElementById('profileThemeDescriptionText');

			if (profileThemeSelect && window.ThemeManager) {
				// Set initial value
				const currentTheme = document.documentElement.getAttribute('data-bs-theme') || 'auto';
				profileThemeSelect.value = currentTheme;
				
				// Update display
				if (window.ThemeManager.themes[currentTheme]) {
					currentThemeDisplay.textContent = window.ThemeManager.themes[currentTheme].name;
					profileThemeDescText.textContent = window.ThemeManager.themes[currentTheme].description;
				}

				// Handle theme change
				profileThemeSelect.addEventListener('change', function(e) {
					const selectedTheme = e.target.value;
					
					// Add animation
					profileThemeSelect.classList.add('theme-changing');
					setTimeout(() => {
						profileThemeSelect.classList.remove('theme-changing');
					}, 300);

					// Update theme via global ThemeManager
					window.ThemeManager.setTheme(selectedTheme, true);

					// Update display
					if (window.ThemeManager.themes[selectedTheme]) {
						currentThemeDisplay.textContent = window.ThemeManager.themes[selectedTheme].name;
						profileThemeDescText.textContent = window.ThemeManager.themes[selectedTheme].description;
					}
				});

				// Listen for theme changes from other sources (e.g., user menu)
				const observer = new MutationObserver(function(mutations) {
					mutations.forEach(function(mutation) {
						if (mutation.attributeName === 'data-bs-theme') {
							const newTheme = document.documentElement.getAttribute('data-bs-theme') || 'auto';
							if (profileThemeSelect.value !== newTheme) {
								profileThemeSelect.value = newTheme;
								if (window.ThemeManager.themes[newTheme]) {
									currentThemeDisplay.textContent = window.ThemeManager.themes[newTheme].name;
									profileThemeDescText.textContent = window.ThemeManager.themes[newTheme].description;
								}
							}
						}
					});
				});

				observer.observe(document.documentElement, {
					attributes: true,
					attributeFilter: ['data-bs-theme']
				});
			}
		});
	</script>
	
	<!-- Active tab data attribute for server-side tab switching -->
	@if (TempData["ActiveTab"] != null)
	{
		<div data-active-tab="@TempData["ActiveTab"]" style="display:none;"></div>
	}
}
